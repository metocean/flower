{% extends "base.html" %}

{% block navbar %}
  {% module Template("navbar.html", active_tab="tasks") %}
{% end %}

{% block container %}
  <div id='task-page' class="container-fluid">
    <div class="row-fluid">
      <div class="span12">
        <div class="page-header">
          <p id="taskid" class="hidden">{{ task.uuid }}</p>
          <h2>{{ getattr(task, 'name', None) }}
            <small>{{ task.uuid }}</small>
            {% if task.state in ["STARTED","RUNNING","ALLOCATING"] %}
                <button style="float: right" class="btn btn-danger" onclick="flower.on_task_terminate(event)">Terminate</button>
            {% elif task.state == "FAILURE" %}
                <button  style="float: right" class="btn btn-danger" onclick="flower.on_task_retry(event)">Retry</button>
            {% elif task.state == "RECEIVED" or task.state == "RETRY" %}
                <button  style="float: right" class="btn btn-danger" onclick="flower.on_task_revoke(event)">Revoke</button>
            {% end %}
          </h2>
        </div>
        <div class="row-fluid">
          <div class="span6">
            <table class="table table-bordered table-striped">
              <caption>Basic task options</caption>
              <tbody>
              <tr id='name'>
                <td>Name</td>
                <td>{{ getattr(task, 'name', None) }}</td>
              </tr>
              <tr id='uuid'>
                <td>UUID</td>
                <td>{{ task.uuid }}</td>
              </tr>
              <tr id='state'>
                <td>State</td>
                <td>
                  {% if task.state == "SUCCESS" %}
                  <span class="label label-success">{{ task.state }}</span>
                  {% elif task.state == "FAILURE" %}
                  <span class="label label-important">{{ task.state }}</span>
                  {% else %}
                  <span class="label label-default">{{ task.state }}</span>
                  {% end %}
                </td>
              </tr>
              <tr id='args'>
                <td>args</td>
                <td><pre>{{ json.dumps(task.args) }}</pre></td>
              </tr>
              <tr id='kwargs'>
                <td>kwargs</td>
                <td><pre>{{ json.dumps(task.kwargs) }}</pre></td>
              </tr>
              <tr id='result'>
                <td>Result</td>
                <td>{{ getattr(task, 'result', '') }}</td>
              </tr>
              </tbody>
            </table>
          </div>

          <div class="span6">
            <table class="table table-bordered table-striped">
              <caption>Advanced task options</caption>
              <tbody>
              {% for name in task._fields %}
                {% if name not in ['name', 'uuid', 'state', 'args', 'kwargs', 'result'] and getattr(task, name, None) is not None %}
                <tr id="{{ name }}">
                  <td>{{ humanize(name) }}</td>
                  <td>
                    {% if name in ['sent', 'received', 'started', 'succeeded', 'retried', 'timestamp', 'failed', 'revoked'] %}
                    {{ humanize(getattr(task, name, None), type='time') }}
                    {% elif name in ['expires', 'eta'] %}
                    {{ humanize(getattr(task, name, None), type='isotime') }}
                    {% elif name == 'worker' %}
                    <a
                        href="{{ reverse_url('worker', task.worker.hostname) }}">{{ task.worker.hostname }}</a>
                    {% elif name == 'traceback' %}
                    <pre>{{ getattr(task, name, None) }}</pre>
                    {% elif name in ['parent_id', 'root_id'] %}
                    <a
                        href="{{ reverse_url('task', getattr(task, name, None)) }}">{{ getattr(task, name, None) }}</a>
                    {% elif name == 'children' %}
                      {% for child in getattr(task, name, {}) %}
                        <a href="{{ reverse_url('task', child.id) }}">{{ child.id }}</a>
                        <br>
                      {% end %}
                    {% else %}
                      {{ getattr(task, name, None) }}
                    {% end %}
                  </td>
                </tr>
                {% end %}
              {% end %}
              </tbody>
            </table>
          </div>           
      </div>
    <div class="row-fluid">
      <div class="span6">
          {% if action_conf %}
          <h3>Action configuration</h3>
          <pre class="prettyprint linenums languague-css">
            {{ action_conf }}
          </pre>
          {% end %}
          {% if workflow %}
          <h3>Workflow</h3>
          <pre class="prettyprint linenums languague-css">
            {% for action_id in workflow %}
              - {{ action_id }}
            {% end %}
          </pre>
          {% end %}
        </div>

        <div class="span6">
          {% if logfile %}
          <h3>Logfile
            <div id="logpath" hidden>{{ logpath }}</div>
            <span style="float: right">
              <button style="line-height: 11px; padding: 3px 7px;" class="btn-small" onclick="$('#logfile').scrollTop(0)" name="top">
                <span class="icon-circle-arrow-up"></span>
              </button>
              <button style="line-height: 11px;  padding: 3px 7px;" class="btn-small" onclick="$('#logfile').scrollTop($('#logfile')[0].scrollHeight)" name="bottom">
                <span class="icon-circle-arrow-down"></span>
              </button>
            </span>
          </h3>
          <pre id='logfile' class="prettyprint linenums languague-css" style="overflow-y: scroll; max-height:500px">
            {{ logfile }}
          </pre>
          {% else %}
          <h3>Logfile <small> Not found </small></h3>
          {% end %}
        </div>
      </div>
    </div>
  </div>
</div>
{% end %}
