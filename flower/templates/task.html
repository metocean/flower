{% extends "base.html" %}

{% block navbar %}
  {% module Template("navbar.html", active_tab="tasks", sched_app=sched_app()) %}
{% end %}

{% block container %}
  <div id="tz" class="hidden">{{tz}}</div>
  <div id='task-page' class="container-fluid">
    <div class="row-fluid">
      <div class="span12">
        <div class="page-header">
          <p id="taskid" class="hidden">{{ task.uuid }}</p>
          <h2>{{ task.action_id or task.name }} 
            <small>{{ task.uuid }}</small>
            {% if task.state in ["STARTED","RUNNING","ALLOCATING"] %}
                <button style="float: right" class="btn btn-danger" onclick="flower.on_task_terminate(event)">Terminate</button>
            {% elif task.state in ["FAILURE","SUCCESS"] and 'dedicated' not in str(task.worker) %}
                <button  style="float: right" class="btn btn-danger" onclick="flower.on_task_retry(event)">Retry</button>
            {% elif task.state in ["SENT","RECEIVED","RETRY","PENDING"] %}
                <button  style="float: right" class="btn btn-danger" onclick="flower.on_task_revoke(event)">Revoke</button>
            {% end %}
          </h2>
        </div>
        <div class="row-fluid">
          <div class="span6">
            <table class="table table-bordered table-striped">
              <caption>Basic task options</caption>
              <tbody>
              {% if hasattr(task, 'action_id') %}
              <tr id='action_id'>
                <td>Action ID</td>
                <td>{{ task.action_id }}</td>
              </tr>
              {% end %}
              {% if hasattr(task, 'cycle_dt') %}
              <tr id='cycle_dt'>
                <td>Cycle</td>
                <td>{{ task.cycle_dt }}{% if task.end_cycle_dt %}--{{task.end_cycle_dt}}{% end %}</td>
              </tr>
              {% end %}
              <tr id='name'>
                <td>Name</td>
                <td>{{ getattr(task, 'name', None) }}</td>
              </tr>
              <tr id='uuid'>
                <td>UUID</td>
                <td>{{ task.uuid }}</td>
              </tr>
              <tr id='state'>
                <td>State</td>
                <td>
                  {% if task.state == "SUCCESS" %}
                    <span class="label label-success">{{ task.state }}</span>
                  {% elif task.state in ["FAILURE","REVOKED"] %}
                    <span class="label label-important">{{ task.state }}</span>
                  {% elif task.state in ["ALLOCATING"] %}
                    <span class="label label-queued">{{ task.state }}</span>
                  {% elif task.state in ["STARTED","RUNNING"] %}
                    <span class="label label-info">{{ task.state }}</span>
                  {% elif task.state in ["RETRY"] %}
                    <span class="label label-warning">{{ task.state }}</span>
                  {% else %}
                    <span class="label label-default">{{ task.state }}</span>
                  {% end %}
                </td>
              </tr>
              <tr id='args'>
                <td>args</td>
                <td><pre class="collapsable">{{ to_json(task.args) }}</pre></td>
              </tr>
              <tr id='kwargs'>
                <td>kwargs</td>
                <td><pre class="collapsable">{{ to_json(task.kwargs) }}</pre></td>
              </tr>
              <tr id='result'>
                <td>Result</td>
                <td>{% if isinstance(task.result, dict) and task.result.has_key('progress') %}
                  <div class="progress">
                    <div class="bar" style="width: {{format_progress(task.result['progress'])}}%;">
                    {{round(format_progress(task.result['progress']),1)}}%
                    {% if task.result['status'] %}
                     - {{task.result['status']}}
                    {%end%}
                    </div>
                  </div>
                {% else %}
                  <pre>{{ task.result }}</pre>
                {% end %}</td>
              </tr>
              {% if parent_task %}
              <tr><td>Parent</td><td>{{ getattr(parent_task, 'name', None) }}(<a href="/task/{{parent_task.uuid}}">{{parent_task.uuid}}</a>)</td>
              {% end %}
              {% if child_tasks %}
              <tr><td>Children</td><td>
                <ul class="collapsable">{% for cuuid,child in child_tasks %}
                  <li>{% if getattr(child, 'action_id', None) != getattr(task, 'action_id', None) %}<strong>{{ getattr(child, 'action_id', None) }}@{{ getattr(child, 'cycle_dt', None)}}:</strong> {% end %}{{ getattr(child, 'name', None) }}(<a href="/task/{{cuuid}}">{{cuuid}}</a>)</li>
                {% end %}
                </ul>
                </td>
              </tr>
              {% end %}
              </tbody>
            </table>
          </div>

          <div class="span6">
            <table class="table table-bordered table-striped">
              <caption>Advanced task options</caption>
              <tbody>
              {% for name in task._fields %}
                {% if name not in ['name', 'uuid', 'state', 'args', 'kwargs', 'result','cycle_dt','action_id'] and getattr(task, name, None) is not None %}
                <tr id="{{ name }}">
                  <td>{{ humanize(name) }}</td>
                  <td>
                    {% if name in ['sent', 'received', 'started', 'succeeded', 'retried', 'timestamp', 'failed', 'revoked'] %}
                    {{ humanize(getattr(task, name, None), type='time') }}
                    {% elif name in ['expires', 'eta'] %}
                    {{ humanize(getattr(task, name, None), type='isotime') }}
                    {% elif name == 'worker' %}
                    <a href="{{ reverse_url('worker', task.worker.hostname) }}">{{ task.worker.hostname }}</a>
                    {% elif name in ['traceback','exception'] %}
                    <pre>{{ getattr(task, name, None) }}</pre>
                    {% else %}
                      {{ getattr(task, name, None) }}
                    {% end %}
                  </td>
                </tr>
                {% end %}
              {% end %}
              <tr id='memory'>
                <td>Memory (last / limit)</td>
                <td>{% if task.memory %}
                  {{ task.memory['usage'] }} / {{ task.memory['limit'] }}
                {% else %}
                  Unknown
                {% end %}</td>
              </tr>
              </tbody>
            </table>
          </div>           
      </div>
    <div class="row-fluid">
      <div class="span6">
          {% if action_conf %}
          <h3>Action configuration <small><a href="{{ reverse_url('deps', task.uuid) }}">Dependencies graph</a></small></h3>
          <pre class="prettyprint linenums languague-css">
            {{ action_conf }}
          </pre>
          {% end %}
          {% if task.actions_id or task.workflows_id %}
            {% if isinstance(task.result, dict) and task.result.has_key('state') %}
              <h3>Pending <small>(Waiting for dependencies)</small></h3> 
              <pre class="collapsable prettyprint linenums languague-css">
              {% for cycle_str in sorted(task.result['state']['pending']) %}
                  {% for action_id in task.result['state']['pending'][cycle_str] %}
                    - {{ action_id }} @ {{ cycle_str }}<br>
                  {% end %}
                
              {% end %}
              </pre>
              <h3>Scheduled/Running</h3> 
              <pre class="collapsable prettyprint linenums languague-css">
              {% for cycle_str in sorted(task.result['state']['running']) %}
                  {% for action_id in task.result['state']['running'][cycle_str] %}
                    - {{ action_id }} @ {{ cycle_str }}<br>
                  {% end %}
              {% end %}
              </pre>
              <h3>Failed</h3>
              <pre class="collapsable prettyprint linenums languague-css">
                {% for cycle_str in sorted(task.result['state']['failed']) %}
                  {% for action_id in task.result['state']['failed'][cycle_str] %}
                    - {{ action_id }} @ {{ cycle_str }}<br>
                  {% end %}
              {% end %}
              </pre>
              <h3>Success</h3>
              <pre class="collapsable prettyprint linenums languague-css">
                {% for cycle_str in sorted(task.result['state']['success']) %}
                  {% for action_id in task.result['state']['success'][cycle_str] %}
                    - {{ action_id }} @ {{ cycle_str }}<br>
                  {% end %}
              {% end %}
              </pre>
            {% end %}
            <h3>Full workflow <small><a href="{{ reverse_url('deps', task.uuid) }}">Dependencies graph</a></small></h3>
            <pre class="collapsable prettyprint linenums languague-css">
              {% for action_id in sorted(task.actions_id) %}
                - {{ action_id }}<br>
              {% end %}
            </pre>
          {% end %}
        </div>

        <div class="span6">
          {% if logfile %}
          <h3>Logfile
            <div id="logpath" hidden>{{ logpath }}</div>
            <span style="float: right">
              <button style="line-height: 11px; padding: 3px 7px;" class="btn-small" onclick="$('#logfile').scrollTop(0)" name="top">
                <span class="icon-circle-arrow-up"></span>
              </button>
              <button style="line-height: 11px;  padding: 3px 7px;" class="btn-small" onclick="$('#logfile').scrollTop($('#logfile')[0].scrollHeight)" name="bottom">
                <span class="icon-circle-arrow-down"></span>
              </button>
            </span>
          </h3>
          <pre id='logfile' class="prettyprint linenums languague-css" style="overflow-y: scroll; max-height:500px">
            {{ logfile }}
          </pre>
          {% else %}
          <h3>Logfile <small> Not found </small></h3>
          {% end %}
        </div>
      </div>
    </div>
  </div>
</div>
{% end %}


{% block extra_scripts %}
<script type="text/javascript">
  function add_or_update_field(field, data, after, before){
    if ($("#"+field).length == 0){
        if (after == null) {
            $('#'+before).before('<tr id="'+field+'"><td>'+toTitleCase(field)+'</td><td>'+data+'</td></tr>');
        } else {
            $('#'+after).after('<tr id="'+field+'"><td>'+toTitleCase(field)+'</td><td>'+data+'</td></tr>');
        }

    } else {
        $('#'+field+' td:eq(1)').html(data);
    }
  }

  function on_task_update(update) {
    var timestamp = moment.unix(update.timestamp).utc(),
        tz = $('#tz').text(),
        status = update.type.split('-')[1]
    timestamp = timestamp.format("YYYY-MM-DD HH:mm:ss "+tz);
    switch (status){
      case "pending":
          var label = "info",
              button = "revoke",
              state = "PENDING";
          break;
      case "sent":
          var label = "default",
              button = "revoke",
              state = "SENT";
          add_or_update_field('retries', update.retries, null, 'worker');
          add_or_update_field('sent', timestamp, null, 'started');
          add_or_update_field('routing_key', update.routing_key, null, 'clock');    
      case "received":
          var label = "default",
              button = "revoke",
              state = "RECEIVED";
          add_or_update_field('received', timestamp, null, 'sent');
          add_or_update_field('retries', update.retries, null, 'worker');
          add_or_update_field('args', update.args, 'state', null);
          add_or_update_field('kwargs', JSON.stringify(JSON.parse(update.kwargs),null,4), 'args', null);
          add_or_update_field('expires', update.expires, null, 'retries');
          if (update.eta) {
              add_or_update_field('eta', update.eta, null, 'expires');
          }
          break;
      case "started":
          var label = "info",
              button = "terminate",
              state = "STARTED";
          add_or_update_field("started", timestamp, "sent", null);
          break;
      case "running":
          var label = "info",
              button = "terminate",
              state = "RUNNING";
          update_progress($('#result td:eq(1)'), update)
          console.log(update)
          add_or_update_field('memory', update.result['memory_usage']+ ' / '+  update.result['memory_limit'], 'client', null);
          break;
      case "allocating":
          var label = "queued",
              button = "terminate",
              state = "ALLOCATING";
          break;
      case "succeeded":
          var label = "success",
              button = "retry",
              state = "SUCCESS";
          add_or_update_field("result", update.result, "kwargs", null);
          add_or_update_field("succedded", timestamp, "started", null);
          add_or_update_field("runtime", update.runtime, "timestamp", null);
          break;
      case "retried":
          var label = "warning",
              button = "revoke",
              state = "RETRY";              
          add_or_update_field("retried", timestamp, "failed", null);
          add_or_update_field("exception", update.exception, null, "timestamp");
          add_or_update_field("traceback", "<pre>"+update.traceback+"</pre>", "timestamp", null);
          break;
      case "revoked":
          var label = "important",
              button = "retry",
              state = "REVOKED";
          break;
      case "failed":
          var label = "important",
              button = "retry",
              state = "FAILURE";
          add_or_update_field("exception", update.exception, null, "timestamp");
          add_or_update_field("traceback", "<pre>"+update.traceback+"</pre>", "timestamp", null);
          add_or_update_field("failed", timestamp, "started", null);
          break;
      default:
          var label = null,
              button = null,
              state = null;
    }
    $('h2 button').remove();
    switch (button) {
        case 'retry':
            if ($.inArray('dedicated', update.hostname)) {
                $('h2 button').remove();     
            } else {
                $('h2').append('<button style="float: right" class="btn btn-danger" onclick="flower.on_task_retry(event)">Retry</button>');
            }
            break;
        case 'terminate':
           $('h2').append('<button style="float: right" class="btn btn-danger" onclick="flower.on_task_terminate(event)">Terminate</button>');
           break;
        case 'revoke':
            $('h2').append('<button  style="float: right" class="btn btn-danger" onclick="flower.on_task_revoke(event)">Revoke</button>');
            break;
        default:
           $('h2 button').remove();
    }
    if (label) {
      $("#state td:eq(1)").html('<span class="label label-'+label+'">'+state+'</span>');
    }
    $("#clock td:eq(1)").text(update.clock);
    $("#timestamp td:eq(1)").text(timestamp);
  }

  function pprint_json(selector){
    var object = JSON.stringify(JSON.parse($(selector).text()),undefined,4);
      $(selector).text(object);
  }
  $('.collapsable').expander({slicePoint: 300,
                              preserveWords: true,
                              detailPrefix: '',
                              afterExpand: function() {
                                  $(".details", this).css("display",'inline');
                              }
                              });
  
  
  if ($('#logfile').length > 0) {
      $('#logfile').scrollTop($('#logfile')[0].scrollHeight);
  }

  function connect_task_socket(update_func, uuid) {
    var host = $(location).attr('host'),
        protocol = $(location).attr('protocol') === 'http:' ? 'ws://' : 'wss://',
        ws = new WebSocket(protocol + host + "/api/task/events/update-task/"+uuid);
    ws.onmessage = function (event) {
        var update = $.parseJSON(event.data);
        update_func(update)
    };
  }
  
  function logfile_update(update){
        var logheight = $('#logfile')[0].scrollTopMax,
            scrollpos = $('#logfile')[0].scrollTop;
        $('#logfile').append(update);
        if (scrollpos == logheight) {
            $('#logfile').scrollTop($('#logfile')[0].scrollTopMax);
        }
    }

  function connect_tail_socket(logfile) {
    var host = $(location).attr('host'),
        protocol = $(location).attr('protocol') == 'http:' ? 'ws://' : 'wss://';

    var ws = new WebSocket(protocol + host + url_prefix() + '/update-logfile/' + logfile);
    ws.onmessage = function (event) {
        logfile_update(event.data+'<br>');
    };
    $(window).on('beforeunload', function(){
        ws.close()    
    });
  }
  
  pprint_json('#kwargs pre');
  
  var uuid = $(location).attr('pathname').split('/')[2],
      logpath = $('#logpath').text();

  connect_task_socket(on_task_update, uuid);
  
  if (logpath){
    connect_tail_socket(logpath)
  };

</script>
{% end %}